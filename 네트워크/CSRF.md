# CSRF
Spring Security 학습 중에 CSRF 공격에 대해 보호 받을 수 있다는 공식문서를 보고 CSRF 개념 중심으로 알아봤따. 


해당 글은 아래의 블로그와 사이트 내용을 조합한 글이다. 

- https://itstory.tk
- https://www.youtube.com/watch?v=nzoUgKPwn_A
- 위키백과


### 1. CSRF(Cross-Site Request Forgery)란?
사이트 간 요청 위조(CSRF)는 웹 사이트 취약점 공격의 하나로, 사용자가 자신의 의지와 상관없이 공격자가 의도한 행위를 특정 웹사이트에 요청하게 만드는 공격이다. 

(유명 사이트인 옥션에서 발생한 개인정보 유출사건에서 사용된 공격 방식 중 하나)

CSRF는 특정 웹사이트가 사용자의 웹 브라우저를 신용하는 상태(권한을 취득한 사용자)를 노린다. 일단 사용자가 웹사이트에 로그인한 상태에서 CSRF 공격 코드가 삽입된 페이지를 열면, 공격 대상이 되는 웹사이트는 위조된 공격 명령이 믿을 수 있는 사용자로부터 발송된 것으로 판단하게 되어 공격에 노출된다.
(출처 : 위키백과)


대략 이해한건 사용자의 권한을 뺏어오는 방식은 불가능하다보니, 특정 사용자의 권한을 이용하여 특정 행동을 유도하여 공격 할 수 있는 것 같다.


### 2. 공격과정

 1. CSRF 공격 전제조건
 - 위조 요청을 전송하는 서비스에 희생자가 로그인한 상태
 - 희생자가 해커가 만든 피싱 사이트에 접속 

 이용자는 웹사이트에 로그인하여 정상적인 쿠키를 발급받는다. 공격자는 다음과 같은 링크를 이메일이나 게시판 등의 경로를 통해 이용자에게 전달한다.

http://www.geocities.com/attacker

공격용 HTML 페이지는 다음과 같은 이미지태그를 가진다.

<img src= "https://travel.service.com/travel_update?.src=Korea&.dst=Hell">

해당 링크는 클릭시 정상적인 경우 출발지와 도착지를 등록하기위한 링크이다. 위의 경우 도착지를 변조하였다.
이용자가 공격용 페이지를 열면, 브라우저는 이미지 파일을 받아오기 위해 공격용 URL을 연다.

이용자의 승인이나 인지 없이 출발지와 도착지가 등록됨으로써 공격이 완료된다. 해당 서비스 페이지는 등록 과정에 대해 단순히 쿠키(세션아이디) 통한 본인확인 밖에 하지 않으므로 공격자가 정상적인 이용자의 수정이 가능하게 된다.


위의 내용은 위키백과에 있는 내용을 그대로 가져온 내용들이다. 


### 3. 방어 방법


1. Referrer 검증
 Referer 용어는 처음 들어봤다. Referer 요청된 Http header에 담겨있으며, 현재 요청된 페이지의 링크 이전의 웹페이지 주소를 포함한다. 사람들이 어디로부터 와서 방문 중인지를 알 수 있다. 하지만 Referer는 변조가 가능하기 때문에 이에 대한 검증 또한 필요하다.

 만약 내가 a.domain.com에서 b.domain.com을 클릭하면 header 값에 a.domain.com으로부터 온 주소가 담겨져 있다. 그래서 CSRF 공격에 이 Referrer이 유효한 도메인지 검증하면 된다.

2. CSRF Token 사용
 Session에 사용자별로 유니크한 값을 담는 방법이 있다. 예를 들어 key값에 "CSRF_TOKEN"을 넣고 value로 난수를 생성하여 돌려주면, 요청이 들어올 때마다 해당 난수값과 맞는지 비교하여 사용자를 검증하는 방법이 있다.


 
